---
# tasks file for vncserver_inst

# - name: "apt cache update"
#   become: yes
#   shell: "echo 'add VirtualBox repository:' \
# wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add - && \
# wget -q https://www.virtualbox.org/download/oracle_vbox.asc -O- | sudo apt-key add - && \
# echo 'added sUCCESSFULLY!!!'"

#   # failed_when: False

# wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
# wget -q https://www.virtualbox.org/download/oracle_vbox.asc -O- | sudo apt-key add -

- name: config 3rd party repos for VirtualBox
  become: yes
  block:
    #----------------------------------
    #MS VS Code
    #----------------------------------
    # https://linuxize.com/post/how-to-install-visual-studio-code-on-ubuntu-18-04/
    # wget -q https://packages.microsoft.com/keys/microsoft.asc -O- | sudo apt-key add -
    # sudo add-apt-repository "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
    # sudo apt update
    # sudo apt install code

    # always try to use HTTPS. I'm not sure why the nginx folks don't provide it.
    - name: add Oracle VirtualBox2016 apt-key (Legacy)
      apt_key:
        url: https://www.virtualbox.org/download/oracle_vbox_2016.asc
        state: present
      # when: linux_old is defined and linux_old
    - name: add Oracle VirtualBox apt-key
      apt_key:
        url: https://www.virtualbox.org/download/oracle_vbox.asc
        state: present

    #replaced by command below
    # - name: add MS VS Code apt repository
    #   become: yes
    #   apt_repository:
    #     # repo: 'deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main'
    #     # repo: deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main
    #     repo: deb https://packages.microsoft.com/repos/vscode stable main
    #     state: present
    #     # filename: msvscode
    #     # update_cache: yes

    - name: add Oracle VirtualBox add-apt-repository
      become: yes
      command: add-apt-repository "deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian eoan contrib"
      # when: linux_old is defined and linux_old
    # sudo add-apt-repository "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"

    - name: "apt cache update"
      apt: "update_cache=True"
      become: yes
      failed_when: False

    - name: "apt soft install"
      become: yes
      apt:
        # name: ['vnc4server', 'whois', 'sudo']
        # sudo apt-get install mate-desktop-environment-extras caja*
        name: ['virtualbox', 'vagrant']
        # name: ['virtualbox-6.1'] # IS NOT COMPATIBLE with vagrant 2.2.3 (probably up to 2.2.6 too)


# Could error with
# virtualbox-dkms set to manually installed.
# linux-headers-generic is already the newest version (5.3.0.24.28).
# may be install manually
# OR reboot host and try again

    - name: "apt soft temporary remove"
      become: yes
      apt:
        state: absent
        name: ['vagrant-libvirt']

# vagrant plugin install vagrant-disksize vagrant-vbguest
    - name: add vagrant plugins
      become: yes
      command: vagrant plugin install vagrant-disksize vagrant-vbguest
      # when: linux_old is defined and linux_old

    # - name: "apt soft back after temporary remove"
    #   become: yes
    #   apt:
    #     state: present
    #     name: ['vagrant-libvirt']

# vboxusers - add to this group necessary users!
- name: Add the users with a bash shell, appending the groups  admins,sudo,docker to the user's groups
  user:
    name: {{ item }}
    # shell: /bin/bash
    groups: admins,sudo,docker
    append: yes
  with_items:
    - vnc
    - su
    - serg

- name: add common storage for VMs to root user
  become: yes
  command: vboxmanage setproperty machinefolder /mnt/zfs05tb_kvm/vbox

- name: add common storage for VMs to other users
  become: yes
  shell: sudo -u {{ item }} 'vboxmanage setproperty machinefolder /mnt/zfs05tb_kvm/vbox'
  with_items:
    - vnc
    - su
    - serg

